ALTER TABLE DOC19_EXPIRATIONS ADD ALREADY_PAYED DECIMAL(18,5) NULL;

UPDATE DOC19_EXPIRATIONS SET ALREADY_PAYED=0 WHERE PAYED_VALUE IS NULL;
UPDATE DOC19_EXPIRATIONS SET ALREADY_PAYED=PAYED_VALUE WHERE PAYED_VALUE IS NOT NULL;

CREATE TABLE DOC27_PAYMENTS (
  COMPANY_CODE_SYS01 VARCHAR(20) NOT NULL,
  PROGRESSIVE NUMERIC(12) NOT NULL,
  PAYMENT_DATE DATETIME NULL,
  PAYMENT_VALUE DECIMAL(18,5) NULL,
  CUSTOMER_SUPPLIER_CODE VARCHAR(20) NULL,
  ACCOUNT_CODE_ACC02 VARCHAR(20) NULL,
  BANK_CODE_REG12 VARCHAR(20) NULL,
  PAYMENT_TYPE_CODE_REG11 VARCHAR(20) NULL,
  CURRENCY_CODE_REG03 VARCHAR(20) NULL,
  PROGRESSIVE_REG04 NUMERIC(12) NULL,
  PRIMARY KEY(COMPANY_CODE_SYS01, PROGRESSIVE),
  INDEX DOC27_FKIndex1(COMPANY_CODE_SYS01),
  INDEX DOC27_FKIndex2(BANK_CODE_REG12),
  INDEX DOC27_FKIndex3(COMPANY_CODE_SYS01, ACCOUNT_CODE_ACC02),
  INDEX DOC27_FKIndex4(COMPANY_CODE_SYS01,PAYMENT_TYPE_CODE_REG11),
  INDEX DOC27_FKIndex5(CURRENCY_CODE_REG03),
  INDEX DOC27_FKIndex6(COMPANY_CODE_SYS01, PROGRESSIVE_REG04),
  FOREIGN KEY(COMPANY_CODE_SYS01)
    REFERENCES SYS01_COMPANIES(COMPANY_CODE)
      ON DELETE NO ACTION
      ON UPDATE NO ACTION,
  FOREIGN KEY(BANK_CODE_REG12)
    REFERENCES REG12_BANKS(BANK_CODE)
      ON DELETE NO ACTION
      ON UPDATE NO ACTION,
  FOREIGN KEY(COMPANY_CODE_SYS01, ACCOUNT_CODE_ACC02)
    REFERENCES ACC02_ACCOUNTS(COMPANY_CODE_SYS01, ACCOUNT_CODE)
      ON DELETE NO ACTION
      ON UPDATE NO ACTION,
  FOREIGN KEY(COMPANY_CODE_SYS01,PAYMENT_TYPE_CODE_REG11)
    REFERENCES REG11_PAY_TYPES(COMPANY_CODE_SYS01,PAYMENT_TYPE_CODE)
      ON DELETE NO ACTION
      ON UPDATE NO ACTION,
  FOREIGN KEY(CURRENCY_CODE_REG03)
    REFERENCES REG03_CURRENCIES(CURRENCY_CODE)
      ON DELETE NO ACTION
      ON UPDATE NO ACTION,
  FOREIGN KEY(COMPANY_CODE_SYS01, PROGRESSIVE_REG04)
    REFERENCES REG04_SUBJECTS(COMPANY_CODE_SYS01, PROGRESSIVE)
      ON DELETE NO ACTION
      ON UPDATE NO ACTION
);


CREATE TABLE DOC28_PAYMENT_DISTRIBUTION (
  COMPANY_CODE_SYS01 VARCHAR(20) NOT NULL,
  PROGRESSIVE_DOC27 NUMERIC(12) NOT NULL,
  PROGRESSIVE_DOC19 NUMERIC(12) NOT NULL,
  PAYMENT_VALUE DECIMAL(18,5) NOT NULL,
  PAYED CHAR(1),
  PRIMARY KEY(COMPANY_CODE_SYS01, PROGRESSIVE_DOC27, PROGRESSIVE_DOC19),
  INDEX DOC28_FKIndex1(COMPANY_CODE_SYS01, PROGRESSIVE_DOC27),
  INDEX DOC28_FKIndex2(COMPANY_CODE_SYS01, PROGRESSIVE_DOC19),
  FOREIGN KEY(COMPANY_CODE_SYS01, PROGRESSIVE_DOC27)
    REFERENCES DOC27_PAYMENTS(COMPANY_CODE_SYS01, PROGRESSIVE)
      ON DELETE NO ACTION
      ON UPDATE NO ACTION,
  FOREIGN KEY(COMPANY_CODE_SYS01, PROGRESSIVE_DOC19)
    REFERENCES DOC19_EXPIRATIONS(COMPANY_CODE_SYS01, PROGRESSIVE)
      ON DELETE NO ACTION
      ON UPDATE NO ACTION
);

INSERT INTO DOC27_PAYMENTS(COMPANY_CODE_SYS01,PROGRESSIVE,PAYMENT_DATE,PAYMENT_VALUE,CUSTOMER_SUPPLIER_CODE,ACCOUNT_CODE_ACC02,PAYMENT_TYPE_CODE_REG11,PROGRESSIVE_REG04,CURRENCY_CODE_REG03)
SELECT COMPANY_CODE_SYS01,PROGRESSIVE,PAYED_DATE,PAYED_VALUE,CUSTOMER_SUPPLIER_CODE,REAL_ACCOUNT_CODE_ACC02,REAL_PAYMENT_TYPE_CODE_REG11,PROGRESSIVE_REG04,CURRENCY_CODE_REG03
FROM DOC19_EXPIRATIONS WHERE PAYED='Y';

INSERT INTO DOC28_PAYMENT_DISTRIBUTION(COMPANY_CODE_SYS01,PROGRESSIVE_DOC27,PROGRESSIVE_DOC19,PAYMENT_VALUE,PAYED)
SELECT COMPANY_CODE_SYS01,PROGRESSIVE,PROGRESSIVE,PAYED_VALUE,PAYED FROM DOC19_EXPIRATIONS WHERE PAYED='Y';

INSERT INTO SYS20_COMPANY_PROGRESSIVES(COMPANY_CODE_SYS01,TABLE_NAME,COLUMN_NAME,VALUE)
SELECT COMPANY_CODE_SYS01,'DOC27_PAYMENTS','PROGRESSIVE',MAX(PROGRESSIVE) FROM DOC19_EXPIRATIONS GROUP BY COMPANY_CODE_SYS01;

